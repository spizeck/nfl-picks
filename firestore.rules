rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Games collection - read-only for all authenticated users
    match /games/{gameId} {
      allow read: if request.auth != null;
      allow write: if false; // Only backend can write
    }
    
    // Cache collection - read-only for all authenticated users
    match /cache/{cacheId} {
      allow read: if request.auth != null;
      allow write: if false; // Only backend can write
    }
    
    // Users collection
    match /users/{userId} {
      // All authenticated users can read profiles (for leaderboard and avatars)
      allow read: if request.auth != null;
      // Users can update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      // Only backend can create user documents
      allow create: if false;
      allow delete: if false;
      
      // Season stats - users can read their own, all users can read others for leaderboard
      match /seasons/{seasonId} {
        allow read: if request.auth != null;
        allow write: if false; // Only backend updates stats
        
        // Week stats and picks
        match /weeks/{weekId} {
          allow read: if request.auth != null;
          allow write: if false; // Only backend updates stats
          
          // User picks - users can only write their own picks before game starts
          match /picks/{pickId} {
            // Anyone authenticated can read picks (visibility handled by backend)
            allow read: if request.auth != null;
            // Users can only write their own picks
            allow create, update: if request.auth != null 
              && request.auth.uid == userId
              && (!resource.exists || !resource.data.locked);
            allow delete: if false;
          }
        }
      }
    }
  }
}